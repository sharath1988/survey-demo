angular.module("mwFormViewer",["ngSanitize","ui.bootstrap","ng-sortable","pascalprecht.translate"]),angular.module("mwFormViewer").directive("mwPriorityList",function(){return{replace:!0,restrict:"AE",require:"^mwFormQuestion",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?"},templateUrl:"mw-priority-list.html",controllerAs:"ctrl",bindToController:!0,controller:function(){function e(e){if(e)for(var t=0;t<e.length;t++){var n=e[t];n.priority=t+1}}function t(e){e.sort(function(e,t){return e.priority-t.priority})}var n=this;n.questionResponse.priorityList||(n.questionResponse.priorityList=[]),n.idToItem={},t(n.questionResponse.priorityList),n.availableItems=[],n.question.priorityList.forEach(function(e){n.idToItem[e.id]=e;var t=n.questionResponse.priorityList.some(function(t){return e.id==t.id});t||n.availableItems.push({priority:null,id:e.id})}),n.allItemsOrdered=0==n.availableItems.length||null;var s={disabled:n.readOnly,ghostClass:"beingDragged"};n.orderedConfig=angular.extend({},s,{group:{name:"A",pull:!1,put:["B"]},onEnd:function(t,s){e(n.questionResponse.priorityList)}}),n.availableConfig=angular.extend({},s,{sort:!1,group:{name:"B",pull:["A"],put:!1},onEnd:function(t,s){e(n.questionResponse.priorityList),n.allItemsOrdered=0==n.availableItems.length||null}})},link:function(e,t,n,s){var r=e.ctrl;r.print=s.print}}}),angular.module("mwFormViewer").directive("mwFormViewer",function(){return{replace:!0,restrict:"AE",scope:{formData:"=",responseData:"=",templateData:"=?",readOnly:"=?",options:"=?",formStatus:"=?",onSubmit:"&",api:"=?"},templateUrl:"mw-form-viewer.html",controllerAs:"ctrl",bindToController:!0,controller:["$timeout","$interpolate",function(e,t){function n(){s.formData.pages.sort(function(e,t){return e.number-t.number})}var s=this;s.defaultOptions={nestedForm:!1,autoStart:!1,disableSubmit:!1},s.options=angular.extend({},s.defaultOptions,s.options),s.submitStatus="NOT_SUBMITTED",s.formSubmitted=!1,n(),s.pageIdToPage={},s.formData.pages.forEach(function(e){s.pageIdToPage[e.id]=e}),s.buttons={prevPage:{visible:!1,disabled:!1},nextPage:{visible:!1,disabled:!1},submitForm:{visible:!1,disabled:!1}},s.submitForm=function(){s.formSubmitted=!0,s.submitStatus="IN_PROGRESS",s.setCurrentPage(null);var e=s.onSubmit();e.then(function(){s.submitStatus="SUCCESS"})["catch"](function(){s.submitStatus="ERROR"})},s.setCurrentPage=function(e){return s.currentPage=e,e?(s.setDefaultNextPage(),void s.initResponsesForCurrentPage()):(s.buttons.submitForm.visible=!1,s.buttons.prevPage.visible=!1,void(s.buttons.nextPage.visible=!1))},s.setDefaultNextPage=function(){var e=s.formData.pages.indexOf(s.currentPage);if(s.currentPage.isFirst=0==e,s.currentPage.isLast=e==s.formData.pages.length-1,s.buttons.submitForm.visible=s.currentPage.isLast,s.buttons.prevPage.visible=!s.currentPage.isFirst,s.buttons.nextPage.visible=!s.currentPage.isLast,s.currentPage.isLast?s.nextPage=null:s.nextPage=s.formData.pages[e+1],s.currentPage.pageFlow){var t=!1;s.currentPage.pageFlow.formSubmit?(s.nextPage=null,t=!0):s.currentPage.pageFlow.page?(s.nextPage=s.pageIdToPage[s.currentPage.pageFlow.page.id],s.buttons.nextPage.visible=!0):s.currentPage.isLast&&(s.nextPage=null,t=!0),s.buttons.submitForm.visible=t,s.buttons.nextPage.visible=!t}},s.initResponsesForCurrentPage=function(){s.currentPage.elements.forEach(function(e){var t=e.question;t&&!s.responseData[t.id]&&(s.responseData[t.id]={})})},s.beginResponse=function(){s.formData.pages.length>0&&s.setCurrentPage(s.formData.pages[0])},s.resetPages=function(){s.prevPages=[],s.currentPage=null,s.nextPage=null,s.formSubmitted=!1,s.options.autoStart&&s.beginResponse()},s.resetPages(),s.goToPrevPage=function(){var e=s.prevPages.pop();s.setCurrentPage(e),s.updateNextPageBasedOnAllAnswers()},s.goToNextPage=function(){s.prevPages.push(s.currentPage),s.updateNextPageBasedOnAllAnswers(),s.setCurrentPage(s.nextPage)},s.updateNextPageBasedOnAllAnswers=function(){s.currentPage.elements.forEach(function(e){s.updateNextPageBasedOnPageElementAnswers(e)}),s.buttons.submitForm.visible=!s.nextPage,s.buttons.nextPage.visible=!!s.nextPage},s.updateNextPageBasedOnPageElementAnswers=function(e){var t=e.question;t&&t.pageFlowModifier&&t.offeredAnswers.forEach(function(e){e.pageFlow&&s.responseData[t.id].selectedAnswer==e.id&&(e.pageFlow.formSubmit?s.nextPage=null:e.pageFlow.page&&(s.nextPage=s.pageIdToPage[e.pageFlow.page.id]))})},s.onResponseChanged=function(e){s.setDefaultNextPage(),s.updateNextPageBasedOnAllAnswers()},s.api&&(s.api.reset=function(){for(var t in s.responseData)s.responseData.hasOwnProperty(t)&&delete s.responseData[t];s.buttons.submitForm.visible=!1,s.buttons.prevPage.visible=!1,s.buttons.nextPage.visible=!1,s.currentPage=null,e(s.resetPages,0)}),s.print=function(e){return s.templateData?t(e)(s.templateData):e}}],link:function(e,t,n){var s=e.ctrl;s.formStatus&&(s.formStatus.form=s.form)}}}),angular.module("mwFormViewer").factory("FormQuestionId",function(){var e=0;return{next:function(){return++e}}}).directive("mwFormQuestion",function(){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?",onResponseChanged:"&?"},templateUrl:"mw-form-question.html",controllerAs:"ctrl",bindToController:!0,controller:["$timeout","FormQuestionId",function(e,t){var n=this;n.id=t.next(),"radio"==n.question.type?(n.questionResponse.selectedAnswer||(n.questionResponse.selectedAnswer=null),n.questionResponse.other&&(n.isOtherAnswer=!0)):"checkbox"==n.question.type?(n.questionResponse.selectedAnswers&&n.questionResponse.selectedAnswers.length?n.selectedAnswer=!0:n.questionResponse.selectedAnswers=[],n.questionResponse.other&&(n.isOtherAnswer=!0)):"grid"==n.question.type?n.question.grid.cellInputType||(n.question.grid.cellInputType="radio"):"division"==n.question.type&&(n.computeDivisionSum=function(){n.divisionSum=0,n.question.divisionList.forEach(function(e){0==n.questionResponse[e.id]||n.questionResponse[e.id]?n.divisionSum+=n.questionResponse[e.id]:(n.questionResponse[e.id]=null,n.divisionSum+=0)})},n.computeDivisionSum()),n.isAnswerSelected=!1,n.selectedAnswerChanged=function(){delete n.questionResponse.other,n.isOtherAnswer=!1,n.answerChanged()},n.otherAnswerRadioChanged=function(){void 0,n.isOtherAnswer&&(n.questionResponse.selectedAnswer=null),n.answerChanged()},n.otherAnswerCheckboxChanged=function(){n.isOtherAnswer||delete n.questionResponse.other,n.selectedAnswer=!(!n.questionResponse.selectedAnswers.length&&!n.isOtherAnswer)||null,n.answerChanged()},n.toggleSelectedAnswer=function(e){n.questionResponse.selectedAnswers.indexOf(e.id)===-1?n.questionResponse.selectedAnswers.push(e.id):n.questionResponse.selectedAnswers.splice(n.questionResponse.selectedAnswers.indexOf(e.id),1),n.selectedAnswer=!(!n.questionResponse.selectedAnswers.length&&!n.isOtherAnswer)||null,n.answerChanged()},n.answerChanged=function(){n.onResponseChanged&&n.onResponseChanged()}}],link:function(e,t,n,s){var r=e.ctrl;r.print=s.print}}}),angular.module("mwFormViewer").directive("mwFormConfirmationPage",function(){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{submitStatus:"=",confirmationMessage:"=",readOnly:"=?"},templateUrl:"mw-form-confirmation-page.html",controllerAs:"ctrl",bindToController:!0,controller:function(){},link:function(e,t,n,s){var r=e.ctrl;r.print=s.print}}});